name: Remove iOS from supportedPlatforms

on:
  push:
    branches:
      - gh-on/off-nft-swap-demo

jobs:
  remove_ios:
    runs-on: ubuntu-latest
    permissions:
      # Give the default GITHUB_TOKEN write permission to commit and push the
      # added or changed files to the repository.
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Read and Modify supportedPlatforms in JSON files
        id: modify_json
        shell: python
        run: |
          import json
          import os

          file_paths = [
              'dapp_store/geneva-nft.json',
              'dapp_store/geneva-swap-info.json',
              'dapp_store/geneva-swap.json'
          ]
          modified_files_content = {}

          for file_path in file_paths:
            if not os.path.exists(file_path):
              print(f"Error: File not found at {file_path}")
              continue

            with open(file_path, 'r') as f:
              try:
                data = json.load(f)
              except json.JSONDecodeError as e:
                print(f"Error decoding JSON in {file_path}: {e}")
                continue

            modified = False
            if "app" in data and "supportedPlatforms" in data["app"]:
              if "iOS" in data["app"]["supportedPlatforms"]:
                data["app"]["supportedPlatforms"].remove("iOS")
                print(f"'iOS' removed from supportedPlatforms in {file_path}")
                modified = True

            if modified:
              with open(file_path, 'w') as f:
                json.dump(data, f, indent=2)
              print(f"{file_path} updated.")
              with open(file_path, 'r') as f:
                modified_files_content[file_path] = f.read()
            else:
              print(f"'iOS' not found in supportedPlatforms in {file_path}, skipping.")

          print(f"::set-output name=modified_json_content::{json.dumps(modified_files_content)}")

      # - name: Print Modified JSON Content
      #   if: steps.modify_json.outputs.modified_json_content != '{}'
      #   run: |
      #     import json
      #     modified_content = json.loads('${{ steps.modify_json.outputs.modified_json_content }}')
      #     echo "--- Modified JSON Content ---"
      #     for file, content in modified_content.items():
      #       echo "File: $file"
      #       echo "$content"
      #       echo "---"

      - name: Commit and Push Changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Remove iOS from supportedPlatforms in JSON files"
          push_options: "--force" # Be cautious with --force
          file_pattern: "dapp_store/*.json"
          branch: gh-on/off-nft-swap-demo
          repository: .
